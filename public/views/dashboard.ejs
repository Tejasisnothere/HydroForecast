<%
    const user = data.user || { name: 'Guest User', role: 'Viewer' };
    const predictionLevel = data.prediction.level || 75;
    
    // Derived variables for dynamic styling and text
    const statusType = predictionLevel < 30 ? 'critical' : (predictionLevel < 60 ? 'warning' : 'healthy');
    const statusClass = statusType === 'critical' ? 'text-danger' : (statusType === 'warning' ? 'text-warning' : 'text-success');
    const statusFillClass = statusType === 'critical' ? 'fill-critical' : (statusType === 'warning' ? 'fill-warning' : '');
    const statusText = statusType === 'critical' ? 'CRITICAL LOW' : (statusType === 'warning' ? 'Warning Level' : 'Stable Reserve');
    
    const forecast = data.weather.forecast || "Weather data pending.";
    const usageToday = data.usage.today || 'N/A';
    const usageTrend = data.usage.trend || 'No recent trend data.';
    const rwhPotential = data.rwh.potential || 'N/A'; 
    const activeAlerts = data.alerts.active || [];
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaterMind Reserve Predictor - Animated</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Global & Theme Styles */
        :root {
            --primary-water: #007bff;
            --secondary-water: #4c9ef7;
            --alert-red: #dc3545;
            --success-green: #28a745;
            --tank-fill: #48b7f3;
            --bg-light: #f0f4f8; 
        }
        body { background-color: var(--bg-light); }
        .navbar-custom { background-color: var(--primary-water); }
        
        /* Interactive Card Animations */
        .card { 
            border: none; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        .card-header-custom { background-color: var(--secondary-water); color: white; padding: 1rem 1.5rem; }

        /* Alert Pulse Animation */
        @keyframes pulse-alert {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .alert-pulse { animation: pulse-alert 2s infinite; }

        /* --- Improved Water Tank Widget Styles --- */
        .water-tank-container {
            position: relative;
            width: 150px;
            height: 250px;
            margin: 20px auto;
        }

        .water-tank-widget {
            width: 100%;
            height: 100%;
            border: 5px solid #aaa;
            border-radius: 15px;
            overflow: hidden;
            position: absolute;
            bottom: 0;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            background-color: #fff;
        }

        .water-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: var(--tank-fill);
            /* KEY: The transition enables the smooth filling animation on load */
            transition: height 1.5s cubic-bezier(0.25, 1, 0.5, 1), background 0.5s; 
            z-index: 1;
        }

        /* The Wave Animation (Better) */
        .water-fill::after {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            width: 200%;
            height: 20px;
            border-radius: 40% 45% 0 0;
            background: inherit;
            animation: gentle-wave 4s linear infinite alternate;
            transform: translateX(0);
        }

        @keyframes gentle-wave {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-50%); }
        }

        /* Dynamic Colors for Water Status */
        .fill-critical { background: var(--alert-red); }
        .fill-warning { background: #ffc107; }
        .water-fill.fill-critical::after { background: var(--alert-red); }
        .water-fill.fill-warning::after { background: #ffc107; }

        .tank-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: bold;
            color: #343a40;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
            z-index: 2;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-custom shadow-lg sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fs-4" href="#"><i class="fas fa-chart-line me-2"></i> WaterMind Predictor</a>
        <span class="navbar-text me-3 text-white">
            Welcome back, <%= user.name %>! (<%= user.role %>)
        </span>
        <a href="/logout" class="btn btn-outline-light rounded-pill">Logout <i class="fas fa-sign-out-alt"></i></a>
    </div>
</nav>

<div class="container my-5">

    <% if (activeAlerts.length > 0) { %>
        <div class="alert alert-danger shadow-sm alert-pulse" role="alert">
            <h4 class="alert-heading"><i class="fas fa-bell me-2"></i> Urgent Action Required!</h4>
            You have **<%= activeAlerts.length %>** high-priority system alerts. 
            <a href="/alerts" class="alert-link fw-bold text-decoration-none ms-2">Click to review immediately.</a>
        </div>
    <% } %>

    <div class="row g-4 mb-5 align-items-stretch">
        <div class="col-lg-4">
            <div class="card shadow-lg p-3 text-center h-100 d-flex flex-column justify-content-center">
                <h5 class="card-title text-muted mb-4">Projected Reserve Visualization</h5>
                <div class="water-tank-container">
                    <div class="water-tank-widget">
                        <div 
                            class="water-fill <%= statusFillClass %>" 
                            data-target-height="<%= predictionLevel %>%" 
                            style="height: 0%;"
                        >
                        </div>
                    </div>
                    <h3 class="tank-overlay">
                         <%= predictionLevel %>%
                    </h3>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-lg border-0 h-100">
                <div class="card-header card-header-custom fs-5">
                    Your Reserve Outlook Summary
                </div>
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <i class="fas fa-tint me-3 display-4 <%= statusClass %>"></i>
                        <div>
                            <p class="fs-2 fw-bold <%= statusClass %> mb-0"><%= statusText %></p>
                            <p class="lead text-muted mb-0">Forecast for the next 7 days.</p>
                        </div>
                    </div>
                    
                    <div class="row text-center mt-4">
                        <div class="col-4 border-end">
                            <p class="stat-value text-primary"><%= data.prediction.confidence %>%</p>
                            <small class="text-muted">Prediction Confidence</small>
                        </div>
                        <div class="col-4 border-end">
                             <p class="stat-value text-success"><i class="fas fa-sync fa-spin" style="font-size: 1.5rem;"></i></p>
                            <small class="text-muted">Live Integration</small>
                        </div>
                        <div class="col-4">
                             <p class="stat-value text-info"><i class="fas fa-calendar-day" style="font-size: 1.5rem;"></i></p>
                            <small class="text-muted">Weekly Forecast</small>
                        </div>
                    </div>

                    <a href="/prediction/detail" class="btn btn-primary btn-lg mt-4 w-100">
                        <i class="fas fa-chart-area me-2"></i> Analyze Water Trends
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">

        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-info"><i class="fas fa-cloud-showers-heavy me-2"></i> Rain Forecast</h5>
                    <p class="card-text fs-4 text-secondary"><%= forecast %></p>
                    <small class="text-muted">Source: External API.</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-warning"><i class="fas fa-water me-2"></i> Today's Usage</h5>
                    <p class="card-text stat-value text-warning"><%= usageToday %> L</p>
                    <p class="card-text fw-bold">Trend: <%= usageTrend %></p>
                    <a href="/data/input" class="btn btn-warning btn-sm mt-2 rounded-pill">Record Usage Data <i class="fas fa-edit"></i></a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <% if (user.role === 'Administrator') { %>
                        <h5 class="card-title text-danger"><i class="fas fa-user-shield me-2"></i> Admin Console</h5>
                        <p class="card-text stat-value text-danger"><%= data.live_user_count %></p>
                        <p class="card-text">System Monitoring: <span class="text-success fw-bold">Operational</span></p>
                        <a href="/admin" class="btn btn-danger btn-sm mt-2 rounded-pill">Manage Settings <i class="fas fa-cog"></i></a>
                    <% } else { %>
                        <h5 class="card-title text-success"><i class="fas fa-fill-drip me-2"></i> RWH Potential</h5>
                        <p class="card-text stat-value text-success"><%= rwhPotential %> L</p>
                        <p class="card-text">Forecast for next month.</p>
                        <a href="/rwh/optimize" class="btn btn-success btn-sm mt-2 rounded-pill">Get Optimization Tips <i class="fas fa-leaf"></i></a>
                    <% } %>
                </div>
            </div>
        </div>

    </div> </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Dynamic Water Tank Animation Script ---
        const waterFill = document.querySelector('.water-fill');
        if (waterFill) {
            // 1. Get the target height set by EJS from the custom data attribute
            const targetHeight = waterFill.getAttribute('data-target-height');

            // 2. The element starts at style="height: 0%;" in EJS.
            
            // 3. Apply the final height after a tiny delay to trigger the CSS transition
            setTimeout(() => {
                waterFill.style.height = targetHeight;
            }, 100); 
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>